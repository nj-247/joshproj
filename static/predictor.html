<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CHD Risk Prediction Tool</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body {
      display: block;
      justify-content: center;
      padding: 40px;
    }
  </style>
</head>
<body>

  <header>
    <div class="content">
      <h1>CHD Risk Prediction Tool</h1>
      <p>Enter your health and lifestyle data below to get a personalized risk assessment for coronary heart disease.</p>
      <a href="/" class="btn-primary" style="margin-top:20px;">&#8592; Back to Home</a>
    </div>
  </header>

  <div class="container">
    <h2>CHD Diagnostic Tool</h2>

    <div class="form-group">
<label>
  Age:
  <input type="number" id="age" name="age" min="0" max="120" required />
</label>
<br />

<label>
  Sex:
  <select id="sex" name="sex" required>
    <option value="0">Male</option>
    <option value="1">Female</option>
  </select>
</label>
<br />

<label>
  Chest Pain Type:
  <select id="chest_pain_type" name="chest_pain_type" required>
    <option value="0">Typical angina</option>
    <option value="1">Atypical angina</option>
    <option value="2">Non-anginal pain</option>
    <option value="3">Asymptomatic</option>
  </select>
</label>
<br />

<label>
  Resting Blood Pressure (mm Hg):
  <input type="number" id="resting_blood_pressure" name="resting_blood_pressure" min="0" max="300" required />
</label>
<br />

<label>
  Serum Cholesterol (mg/dl):
  <input type="number" id="cholestoral" name="cholestoral" min="0" max="600" required />
</label>
<br />

<label>
  Fasting Blood Sugar:
  <select id="fasting_blood_sugar" name="fasting_blood_sugar" required>
    <option value="0">Lower than 120 mg/ml</option>
    <option value="1">Greater than 120 mg/ml</option>
  </select>
</label>
<br />

<label>
  Resting ECG Results:
  <select id="rest_ecg" name="rest_ecg" required>
    <option value="0">ST-T wave abnormality</option>
    <option value="1">Normal</option>
    <option value="2">Left ventricular hypertrophy</option>
  </select>
</label>
<br />

<label>
  Maximum Heart Rate Achieved:
  <input type="number" id="Max_heart_rate" name="Max_heart_rate" min="0" max="250" required />
</label>
<br />

<label>
  Exercise Induced Angina:
  <select id="exercise_induced_angina" name="exercise_induced_angina" required>
    <option value="0">No</option>
    <option value="1">Yes</option>
  </select>
</label>
<br />

<label>
  Oldpeak (ST Depression):
  <input type="number" id="oldpeak" name="oldpeak" step="0.1" required />
</label>
<br />

<label>
  Slope of Peak Exercise ST Segment:
  <select id="slope" name="slope" required>
    <option value="0">Downsloping</option>
    <option value="1">Upsloping</option>
    <option value="2">Flat</option>
  </select>
</label>
<br />

<label>
  Vessels Colored by Fluoroscopy:
  <select id="vessels_colored_by_flourosopy" name="vessels_colored_by_flourosopy" required>
    <option value="1">Zero</option>
    <option value="2">One</option>
    <option value="0">Two</option>
    <option value="3">Three</option>
    <option value="4">Four</option>
  </select>
</label>
<br />

<label>
  Thalassemia:
  <select id="thalassemia" name="thalassemia" required>
    <option value="0">Reversable Defect</option>
    <option value="1">Fixed Defect</option>
    <option value="2">Normal</option>
    <option value="3">No</option>
  </select>
</label>
<br />
    </div>

    <button class="btn-secondary" onclick="mapFeatures()" >Predict</button>
    <div id="vis"></div>

    <div class="report" id="report" style="display: none;">
      <h3>Diagnosis Report</h3>
      <p><strong>CHD Risk Score:</strong> <span id="riskScore"></span></p>
      <p><strong>Risk Category:</strong> <span id="riskCategory"></span></p>

      <h4>Input Feature Breakdown</h4>
      <table>
        <thead>
          <tr>
            <th>Feature</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="featureTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    console.log("Page loaded");


    async function mapFeatures() {
  // Get numeric values directly from form
const age = Number(document.getElementById("age").value);
const rbp = Number(document.getElementById("resting_blood_pressure").value);
const chol = Number(document.getElementById("cholestoral").value);
const maxHeartRate = Number(document.getElementById("Max_heart_rate").value);
const oldpeak = parseFloat(document.getElementById("oldpeak").value);

const sex = parseInt(document.getElementById("sex").value, 10);
const chestPain = parseInt(document.getElementById("chest_pain_type").value, 10);
const fastingBS = parseInt(document.getElementById("fasting_blood_sugar").value, 10);
const restECG = parseInt(document.getElementById("rest_ecg").value, 10);
const exAngina = parseInt(document.getElementById("exercise_induced_angina").value, 10);
const slope = parseInt(document.getElementById("slope").value, 10);
const vessels = parseInt(document.getElementById("vessels_colored_by_flourosopy").value, 10);
const thal = parseInt(document.getElementById("thalassemia").value, 10);

// Build array in the same order as your modelâ€™s training features
const features = [
  age,
  sex,
  chestPain,
  rbp,
  chol,
  fastingBS,
  restECG,
  maxHeartRate,
  exAngina,
  oldpeak,
  slope,
  vessels,
  thal
];





  try {
    // Send numeric features to backend for prediction
    const response = await fetch('/predict', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ features })
    });

    const result = await response.json();
    console.log(result)
  const riskScore = result.risk_score;
  const riskLevel = result.risk_level;

  console.log(`Risk Score: ${riskScore}%`);
  console.log(`Risk Level: ${riskLevel}`);




    // Vega-Lite pie chart spec
    const spec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      data: {
        values: [
          { label: "CHD Risk", value: riskScore / 100 },
          { label: "Remaining", value: 1 - riskScore / 100 }
        ]
      },
      mark: "arc",
      encoding: {
        theta: { field: "value", type: "quantitative" },
        color: {
          field: "label",
          type: "nominal",
          scale: {
            domain: ["CHD Risk", "Remaining"],
            range: ["#e74c3c", "#d7dde5"]
          }
        }
      },
      view: { stroke: null }
    };

    vegaEmbed('#vis', spec);

    // Risk category determination
    const riskCategory = riskScore / 100 < 0.3 ? "Low" : riskScore / 100 < 0.7 ? "Moderate" : "High";

    document.getElementById("riskScore").textContent = riskScore.toFixed(2) + "%";
    document.getElementById("riskCategory").textContent = riskLevel;
    console.log("Risk Score:", document.getElementById("riskScore").textContent);

    // Descriptive feature names
    const featureNames = [
      "Age",
      "Sex",
      "Chest Pain Type",
      "Resting Blood Pressure",
      "Serum Cholestoral",
      "Fasting Blood Sugar",
      "Resting ECG",
      "Max Heart Rate",
      "Exercise Induced Angina",
      "Oldpeak",
      "Slope",
      "Vessels Colored",
      "Thalassemia"
    ];

    // Populate table with numeric values directly
    const featureTable = document.getElementById("featureTable");
    featureTable.innerHTML = "";
    features.forEach((value, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${featureNames[index]}</td><td>${value}</td>`;
      featureTable.appendChild(row);
    });

    document.getElementById("report").style.display = "block";
  } catch (error) {
      console.error("Error during prediction:", error);
      alert("Failed to get prediction. Please try again.");
      console.log("Model input array:", features);
  }


  
}


  </script>
</body>
</html>
